name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  export_and_deploy:
    name: Export and Deploy to GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject SilentWolf API Keys
        run: |
          echo "ðŸ” Injecting SilentWolf API credentials..."
          sed -i 's/SW_API_KEY_PLACEHOLDER/${{ secrets.SILENTWOLF_API_KEY }}/g' scripts/config.gd
          sed -i 's/SW_GAME_ID_PLACEHOLDER/${{ secrets.SILENTWOLF_GAME_ID }}/g' scripts/config.gd
          echo "âœ“ API keys injected successfully"
          echo "ðŸ“ Verifying config.gd (masked):"
          grep -E "SW_API_KEY|SW_GAME_ID" scripts/config.gd | sed 's/\(.\{20\}\).*/\1.../' || echo "Config ready"

      - name: Cleanup and create build folder
        run: rm -rf web_build && mkdir -p web_build

      - name: Export Web (Godot 4.6)
        uses: firebelley/godot-export@v5.2.1
        with:
          godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.6-stable/Godot_v4.6-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://github.com/godotengine/godot/releases/download/4.6-stable/Godot_v4.6-stable_export_templates.tpz
          relative_project_path: .
          relative_export_path: web_build
          use_preset_export_path: true
          archive_output: false

      - name: Verify export structure
        run: |
          echo "=== Build directory structure ==="
          ls -R web_build
          echo "=== Checking for index.html ==="
          find web_build -name "index.html" -type f

      - name: Flatten folder structure
        run: |
          echo "=== Flattening export structure ==="
          # Check if files are in a nested 'web' folder
          if [ -d "web_build/web" ]; then
            echo "Found nested web folder, moving contents up..."
            mv web_build/web/* web_build/ || true
            rmdir web_build/web || true
          fi
          
          # Ensure index.html is directly in web_build
          INDEX_PATH=$(find web_build -name "index.html" -type f | head -n 1)
          if [ -n "$INDEX_PATH" ] && [ "$INDEX_PATH" != "web_build/index.html" ]; then
            echo "Moving index.html to root: $INDEX_PATH -> web_build/index.html"
            INDEX_DIR=$(dirname "$INDEX_PATH")
            if [ "$INDEX_DIR" != "web_build" ]; then
              mv "$INDEX_DIR"/* web_build/ 2>/dev/null || true
              find web_build -mindepth 1 -type d -empty -delete
            fi
          fi
          
          # Create .nojekyll to prevent GitHub from ignoring files with underscores
          touch web_build/.nojekyll
          
          echo "=== Final structure ==="
          ls -la web_build
          echo "=== Verifying index.html location ==="
          ls -la web_build/index.html

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: web_build
          branch: gh-pages
          clean: true